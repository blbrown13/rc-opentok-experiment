import {OpentokService} from './opentok.service';
import {filter, first, map, mergeMap, pluck, switchMap, switchMapTo, tap} from "rxjs/operators";
import {OtEventNames} from './opentok.model';
import * as OT from '@opentok/client';
import {merge, Observable} from "rxjs";
import {Signal, VideoMode} from "./live-session.model";
// const data = require('./secrets.json'); // naz to fix this

// because i don't feel like dealing with this thing right now
const data = {
  "apiKey": "CHANGE_ME",
  "sessionId": "CHANGE_ME",
  "token": "CHANGE_ME"
};

const otService = new OpentokService();
const initializedTokBoxSession = otService.initSession(data.apiKey, data.sessionId);
let coachAudioStreamSubscription: OT.Subscriber;
let coachAudioStreamBlocked$: Observable<OT.Event<any, any>>;

function subscribeCoachAudioFeed(stream: OT.Stream): void {
  otService
    .sessionMediaSubscribe('ao-coach-generic', stream, {
      height: 0,
      insertMode: 'append',
      showControls: false,
      subscribeToAudio: true,
      subscribeToVideo: false,
      width: 0,
    })
    .pipe(
      // tslint:disable:no-console
      tap((_) => console.log('naz:: subscribing to coach audio', _)),
      filter((otSubscription) => !!otSubscription),
      tap((otSubscription) => {
        coachAudioStreamBlocked$ = new Observable((observer) => {
          otSubscription.on(
            `${OtEventNames.AudioBlocked} ${OtEventNames.AudioUnBlocked}`,
            (event: OT.Event<OtEventNames.AudioBlocked | OtEventNames.AudioUnBlocked, OT.Stream>) =>
              observer.next(event)
          );
        });
      }),
      tap((otSubscription) => (coachAudioStreamSubscription = otSubscription)),
      tap(() =>
        otService.sendSessionSignal({ type: Signal.HandLowered, data: otService.connectionId })
      ),
      tap(() =>
        otService.sendSessionSignal({
          type: Signal.StageRequestCanceled,
          data: otService.connectionId,
        })
      )
    )
    .subscribe({
      next: () => {
        console.log('Success, Coach Audio Subscription')
        // this.engageAudio();
      },
      error: (err) => {
        console.log('Error, Coach Audio Subscription: ', err.message);
        // this.engageAudio();
      },
    });
}

initializedTokBoxSession.pipe(
  switchMapTo(otService.connectSession(data.token)),
).subscribe({
  next: n => console.log('Success initLiveSession', n),
  error: e => console.log('Fail initLiveSession', e),
});

otService.coachStreamLifecycleEvents$.pipe(
  filter(event => event.type === OtEventNames.StreamCreated),
  // @ts-ignore event any error - naz fix this
  switchMap(event => otService.sessionMediaSubscribe('camera-outlet', event['stream'], {
    fitMode: 'contain',
    height: '500px',
    insertMode: 'append',
    showControls: false,
    subscribeToAudio: false,
    subscribeToVideo: true,
    width: '800px',
  }))
).subscribe({
  next: n => console.log('Connect to coach video - success', n),
  error: e => console.log('Connect to coach video - fail', e),
});

// @ts-ignore
/**
 * Handle Audio Switching from various audio stream sources
 * Must be subscribed after the view initializes because we need a references to elements on the page.
 */
merge(
  otService.sessionConnectionLifecycleEvents$.pipe(
    first(),
    map((event) =>
      event['target']['streams'].find(
        (s: OT.Stream) => otService.isCoachConnection(s['connection']) && s?.videoType !== VideoMode.Screen
      )
    ),
    tap(_ => console.log('naz:: A ******', _)),
  ),
  otService.coachStreamLifecycleEvents$.pipe(
    // @ts-ignore event any error - naz fix this
    filter((event: OT.Event<any, any>) => event.type === OtEventNames.StreamCreated && event['stream'].videoType !== VideoMode.Screen),
    pluck('stream'),
    tap(_ => console.log('naz:: B ******', _)),
  )
)
  .pipe(
    tap(_ => console.log('naz:: C ******', _)),
    filter((s) => !!s),
    filter((s) => {
      if (!coachAudioStreamSubscription) {
        return true;
      } else {
        // @ts-ignore event any error - naz fix this
        return s.id !== coachAudioStreamSubscription['streamId'];
      }
    })
  )
  .subscribe((stream) => subscribeCoachAudioFeed(stream));

/**
 * Subscribes to the audio stream generated by members joining the session.
 * Must be subscribed after the view initializes because we need a references to elements on the page.
 */
otService.memberStreamLifecycleEvents$
  .pipe(
    // takeUntil(this.destroy$),
    tap((_) => console.log('memberStreamLifecycleEvents$ pre filter', _)),
    filter((event) => event.type === OtEventNames.StreamCreated),
    tap((_) => console.log('memberStreamLifecycleEvents$ post filter', _)),
    mergeMap((event) =>
        otService
        // @ts-ignore event any error - naz fix this
          .sessionMediaSubscribe('ao-member-audio', event['stream'], {
            insertMode: 'append',
            subscribeToAudio: true,
            subscribeToVideo: false,
          })
      /*
      .pipe(
        tap((_) => console.log('memberStreamLifecycleEvents$ pre retry', _)),
        retry(2),
        tap((classMateSubscription) =>
          classMateSubscription.on(
            OtEventNames.AudioLevelUpdated,
            (chatter: OT.Event<OtEventNames.AudioLevelUpdated, OT.Stream>) =>
              this.membersAudioLevelChangeEvent$.next(chatter)
          )
        )
      )
    */
    )
  )
  .subscribe({
    next: s => console.log('Subscribe to other members audio - success', s),
    error: e => console.error('Subscribe to other members audio - fail', e),
  });


otService
  .sessionMediaInitPublisher('ai-member-audio', {
    fitMode: 'contain',
    height: 0,
    insertMode: 'append',
    mirror: false,
    publishAudio: false,
    publishVideo: false,
    style: {
      buttonDisplayMode: 'off',
    },
    videoSource: null,
    width: 0,
  }).subscribe({
  next: s => console.log('Published your audio - success', s),
  error: e => console.log('Published your audio - fail', e),
});
  /*
  .pipe(
    tap((publisher) => {
      // Emits a value if the browser security restrictions on mic changes
      publisher.on({
        accessDenied: () => {
          this.uiStateMicrophone$.next(MicrophoneState.Blocked);
          this.opentokService.coachCommunicationConnection$
            .pipe(
              switchMap((connection) =>
                this.opentokService.sendSessionSignal({
                  type: Signal.StageRequestCanceled,
                  data: this.opentokService.connectionId,
                  to: connection,
                })
              )
            )
            .subscribe();
        },
      });
    }),
    catchError((err) => {
      console.log.error(err);
      this.uiStateMicrophone$.next(MicrophoneState.Muted);
      throw err;
    })
  );
*/
